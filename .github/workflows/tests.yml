# =============================================================================
# Tests Workflow
# Runs unit and integration tests on all platforms
# =============================================================================

name: Tests

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    # Only run on GitHub, skip on Gitea mirrors
    if: github.server_url == 'https://github.com'
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            preset: ci-linux
            name: Linux
          - os: macos-14
            preset: ci-macos
            name: macOS (ARM64)
          - os: windows-2022
            preset: ci-windows
            name: Windows

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------------------------------------------------
      # Platform-specific setup
      # -------------------------------------------------------------------------
      - name: Setup (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build \
            libgl1-mesa-dev \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libxext-dev

      - name: Setup (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install ninja

      - name: Setup (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install ninja

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      # -------------------------------------------------------------------------
      # Build and Test
      # -------------------------------------------------------------------------
      - name: Configure
        run: cmake --preset ${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset ${{ matrix.preset }}

      - name: Run Tests
        run: ctest --preset ${{ matrix.preset }} --output-on-failure

      # -------------------------------------------------------------------------
      # Test Results
      # -------------------------------------------------------------------------
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: build/${{ matrix.preset }}/Testing/
          if-no-files-found: ignore

  # ---------------------------------------------------------------------------
  # Summary job
  # ---------------------------------------------------------------------------
  test-summary:
    if: github.server_url == 'https://github.com'
    needs: test
    runs-on: ubuntu-latest
    name: Test Summary
    
    steps:
      - name: Check test results
        run: echo "All tests completed. Check individual job results above."

  # ---------------------------------------------------------------------------
  # Gitea fallback job (always succeeds)
  # ---------------------------------------------------------------------------
  gitea-skip:
    if: github.server_url != 'https://github.com'
    runs-on: ubuntu-latest
    name: Tests (Gitea - Skipped)
    steps:
      - name: Skip tests on Gitea
        run: echo "Tests skipped on Gitea mirror. Use GitHub for CI/CD."
