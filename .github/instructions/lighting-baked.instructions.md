# Static / baked lighting — strict spec

## Purpose
Enable **static (baked) lighting** for BedWars maps that are authored as **finite templates**.

Static lighting is used to make maps look good with predictable performance, independent of runtime ray marching.

## Hard constraints (must not break)
- **Server-authoritative world:** baked lighting must not affect gameplay rules, validation, hit checks, block protection, etc.
- **Layering:**
  - Baking/offline tooling may live outside runtime layers (new tool target), but runtime simulation remains server-owned.
  - `server/` must remain headless (no raylib).
- **No persistence creep:** baked lighting data is part of the map template, not a live world save.
- **Deterministic:** given the same map template + bake settings, the output must be reproducible.

## Scope
### In-scope (BL-1)
- One global directional light preset per map (typically “sun” or “moon”).
- One ambient term.
- Baked result stored in the map template and applied at render time.
- Bake output for BL-1 is **ambient occlusion only** (no directional occlusion).

### Out of scope (BL-1)
- Real-time GI, emissive propagation, colored bounce lighting.
- Dynamic time-of-day baked transitions (can be added later as multiple baked presets).
- Per-pixel lightmaps for every surface (too heavy for this stage).
- Point lights / emissive propagation.

## LS-1 interaction (note)
- `BlockType::Light` is a marker-only block in BL-1 and must not contribute to baked AO.

## Data representation (required)
Baked lighting must be representable in a way that:
- Works with voxel mesh generation.
- Does not require server-side rendering.
- Can be shipped with the map template.

### BL-1 representation (chosen)
BL-1 uses **per-vertex AO** only.

- Store an AO factor $ao \in [0,1]$ per vertex.
- Runtime storage requirement:
  - Encode AO into `vertexColor` (RGBA8) for the voxel mesh.

### What must be baked
At minimum:
- Ambient occlusion from nearby solids (local neighborhood).
- Optional: a directional occlusion term along the map’s chosen light direction.

## Authoring + bake pipeline (required)
- Baked lighting is generated by an **offline tool** (see map editor spec) and written into the map template.
- The server loads the template and instantiates the authoritative map.
- The client uses the authoritative block state for rendering; baked lighting data is used **only** for shading.

## Runtime interaction rules
- **Template blocks:** must use baked lighting.
- **Player-placed blocks:** use a cheap fallback (neutral AO / constant factor).
- Baked lighting must not require per-frame updates.

## Relationship to ray-marched shadows
- Ray-marched shadows are a **debug/optional runtime effect**.
- Baked lighting is the **baseline** look for shipped maps.
- When both are enabled:
  - Multiply terms conservatively: `final = albedo * (bakedAmbient + bakedDirect) * raymarchShadowFactor`.
  - Never double-apply ambient.

## Bake settings (required)
Map template must record:
- Light type: sun/moon
- Light direction (unit vector)
- Ambient intensity
- (Optional) seed/version for reproducibility

BL-1 map policy:
- Only **one** baked lighting preset per map (no day/night switching at runtime).

## Acceptance criteria (BL-1)
- A map template can contain baked lighting data.
- Loading the map does not require any runtime bake.
- Client renders template blocks with baked shading.
- Player-placed blocks do not crash/tear (even if they fall back to neutral lighting).

## Non-acceptance
- Any design that requires server-side raylib/shaders.
- Any design that introduces persistent world saves.
- Any design that ties gameplay logic (visibility/damage) to baked light values.
